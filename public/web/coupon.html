<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>我的优惠券</title>
    <link rel="stylesheet" href="asset/css/app.css">
    <link rel="stylesheet" href="../layui/css/layui.css">
</head>
<body>
<div class="overview">
    <div class="layui-card coupon">
        <div class="layui-card-header">我的优惠券</div>
        <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
            <ul class="layui-tab-title" id="switch_tab">
                <li class="layui-this" data-status="1">未使用</li>
                <li data-status="2">已使用</li>
                <li data-status="3">已过期</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                </div>
                <div class="layui-tab-item" >
                </div>
                <div class="layui-tab-item" >
                </div>
            </div>
        </div>
    </div>
</div>
<div class="layui-hide nothing_html">
    <div class="nothing">
        <div class="icon">
            <i class="">!</i>
        </div>
        <div class="text">
            [TEXT]
        </div>
    </div>
</div>
<div class="layui-hide coupon_line_html">
    <div class="coupon_line layui-clear" onclick="app.navigateTo('/web/coupon_detail.html?id=[ID]')">
        <div class="left">
            <div class="title"><span>[TITLE]</span></div>
            <div class="price">￥ <span>[PRICE]</span></div>
            <div class="number">No.<span>[NUMBER]</span></div>
        </div>
        <div class="right">
            <div class="status">[STATUS]</div>
            <div class="time">[TIME]</div>
        </div>
    </div>
</div>

<script src="asset/js/jquery.js"></script>
<script src="../layui/layui.js"></script>
<script src="asset/js/app.js"></script>
<script>
    layui.use(['element','flow','layer'], function(){
        //初始化全局数据
        let element = layui.element;
        let layer = layui.layer;
        let flow = layui.flow;

        let skip = 0;
        let take = 10;
        let status = 1;

        let nothing = $('.nothing_html').html();
        let coupon_line = $('.coupon_line_html').html();

        getData();

        $('#switch_tab li').click(function(){
            status = $(this).data('status');
            getData();
        });
        function getData()
        {
            flow.load({
                elem:'.layui-show',
                md:0,
                done(page,next)
                {
                    $.ajax({
                        url: '/api/coupon/collect/memberToSelect',
                        data : {
                            skip : (page-1)*take,
                            take : take,
                            status : status
                        },
                        type : 'post',
                        dataType : 'json',
                        beforeSend(){
                            layer.open({
                                type: 3
                            });
                        },
                        success(r) {
                            let html = '';
                            if(page == 1)
                            {
                                if (r.status == 0)
                                {
                                    html = nothing.replace('[TEXT]',r.msg);
                                }
                                if(r.status == 1)
                                {
                                    let data = r.data;
                                    for(let i in data)
                                    {
                                        html += coupon_line.replace('[TITLE]',data[i].coupon.title).replace('[PRICE]',data[i].price).replace('[NUMBER]',data[i].number).replace('[STATUS]',data[i].status_text).replace('[TIME]',data[i].time).replace('[ID]',data[i].id);
                                    }
                                }
                                $('.layui-tab-item.layui-show').html(html);
                            }

                            layer.closeAll();
                            if(page > 1)
                            {
                                if (r.status == 0)
                                {
                                    layer.msg('没有更多了');
                                }
                                if(r.status == 1)
                                {
                                    let data = r.data;
                                    let html = $('.layui-show').html();
                                    for(let i in data)
                                    {
                                        html += coupon_line.replace('[TITLE]',data[i].coupon.title).replace('[PRICE]',data[i].price).replace('[NUMBER]',data[i].number).replace('[STATUS]',data[i].status_text).replace('[TIME]',data[i].time).replace('[ID]',data[i].id);
                                    }
                                    $('.layui-tab-item.layui-show').html(html);

                                    layer.closeAll();
                                }
                            }
                            next('',page <= r.pages);
                        }
                    });
                }
            });
        }
    });
</script>
</body>
</html>